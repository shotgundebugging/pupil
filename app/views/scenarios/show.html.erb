
<h1><%= @scenario.name %></h1>

<p><%= simple_format(@scenario.description) %></p>

<% if @scenario.rgb_video.attached? || @scenario.depth_video.attached? %>
  <div
    data-controller="synced-videos"
    data-synced-videos-fps-value="30"
    style="display:flex; flex-direction: column; gap: 1rem;">

    <!-- Main row: Videos (left), Canvas (center), Annotations list (right) -->
    <div style="display:flex; gap: 1.5rem; align-items:flex-start;">
      <!-- Left: Videos with overlays (stacked) -->
      <div style="display:flex; flex-direction: column; gap: 1rem;">
        <% if @scenario.rgb_video.attached? %>
          <div style="position: relative; width: 424px; height: 240px;">
            <video
              data-synced-videos-target="rgb"
              preload="auto"
              width="424"
              height="240"
              style="display:block;">
              <source src="<%= url_for(@scenario.rgb_video) %>" type="video/mp4">
            </video>
            <div data-synced-videos-target="rgbOverlay" style="pointer-events:none; position:absolute; inset:0;"></div>
          </div>
        <% else %>
          <p>No RGB video uploaded.</p>
        <% end %>

        <% if @scenario.depth_video.attached? %>
          <div style="position: relative; width: 424px; height: 240px;">
            <video
              data-synced-videos-target="depth"
              preload="auto"
              width="424"
              height="240"
              style="display:block;">
              <source src="<%= url_for(@scenario.depth_video) %>" type="video/mp4">
            </video>
            <div data-synced-videos-target="depthOverlay" style="pointer-events:none; position:absolute; inset:0;"></div>
          </div>
        <% else %>
          <p>No depth video uploaded.</p>
        <% end %>
      </div>

      <!-- Center: Canvas + tools -->
      <div style="flex:1; min-width: 520px;">
        <div
          data-controller="annotations"
          data-annotations-create-url-value="<%= scenario_annotations_path(@scenario) %>"
          data-action="frame-changed@document->annotations#onFrameChanged">

          <h2 style="margin:.25rem 0 .25rem;">Draw mode: Rectangle</h2>
          <canvas
            data-annotations-target="canvas"
            width="848"
            height="480"
            style="border: 1px solid #ccc; display:block; max-width:100%; height:auto;">
          </canvas>

          <!-- Scrubber under the annotation canvas only -->
          <div style="margin-top:.5rem;">
            <input type="range" min="0" max="100" value="0" step="0.01"
                   data-synced-videos-target="slider"
                   data-action="input->synced-videos#seek"
                   style="width: 100%;">
          </div>

          <div style="margin-top:.5rem; display:flex; align-items:center; gap:.5rem; flex-wrap: wrap;">
            <label for="annotation_label">Label:</label>
            <select id="annotation_label" data-annotations-target="labelSelect">
              <% ["sidewalk", "curb", "stair", "obstacle", "car", "person"].each do |label| %>
                <option value="<%= label %>"><%= label %></option>
              <% end %>
            </select>
            <button data-action="click->annotations#saveCurrentAnnotation">Save</button>
            <button data-action="click->annotations#clearAnnotation">Clear</button>
            <span data-annotations-target="info">x: –, y: –, w: –, h: –</span>
          </div>
        </div>
      </div>

      <!-- Right: Scrollable annotations list -->
      <div style="width: 300px; max-height: 540px; overflow: auto; border: 1px solid #e5e7eb; border-radius: 6px; padding: .5rem;">
        <h2 style="margin:0 0 .5rem;">Annotations</h2>
        <turbo-frame id="annotations">
          <% if @scenario.annotations.any? %>
            <%= render @scenario.annotations %>
          <% else %>
            <p>No annotations yet.</p>
          <% end %>
        </turbo-frame>
      </div>
    </div>

    <!-- Bottom controls bar -->
    <div style="display:flex; align-items:center; gap:.5rem; padding-top:.5rem; border-top:1px solid #e5e7eb;">
      <span>Time:</span>
      <span data-synced-videos-target="timeDisplay"></span>
      <span>|</span>
      <span data-synced-videos-target="frameDisplay"></span>
    </div>
  </div>
<% else %>
  <p>No videos uploaded for this scenario.</p>
<% end %>

<p>
  <%= link_to "Back to scenarios", scenarios_path %>
</p>
